---
layout: post
title:  "Bug 1013744 - [e10s] Can't open Web Console using CMD+OPT+K and CMD+OPT+I keyboard shortcuts in e10s"
date:   2014-08-06 12:03:57
categories: bugfix mozilla firefox e10s
tags: e10s keyboard serialization
---
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 5.5.2 (402634)"/><meta name="author" content="dc2511"/><meta name="created" content="2014-07-18 21:03:13 +0000"/><meta name="source-url" content="https://bugzilla.mozilla.org/show_bug.cgi?id=1013744"/><meta name="updated" content="2014-07-23 14:30:12 +0000"/><title>Bug 1013744 - [e10s] Can't open Web Console using CMD+OPT+K and CMD+OPT+I keyboard shortcuts in e10s</title></head><body><div><a shape="rect" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1013744" target="_blank">https://bugzilla.mozilla.org/show_bug.cgi?id=1013744</a><br clear="none"/></div><div><br clear="none"/></div><div>Q: Where are the event handlers for those keyboard commands defined?<br clear="none"/></div><div><br clear="none"/></div><div>Interesting. So, it looks like other keyboard shortcuts work, like opening the Browser Console etc.<br clear="none"/></div><div><br clear="none"/></div><div>The command that opens up the Devtools Toolbox is Tools:DevToolbox...<br clear="none"/></div><div><br clear="none"/></div><div>And the handler calls gDevToolsBrowser.toggleToolboxCommand(gBrowser);<br clear="none"/></div><div><br clear="none"/></div><div>But we never hit that breakpoint, strangely.<br clear="none"/></div><div><br clear="none"/></div><div>Err... is that right? Actually, that's wrong - the keycombo that triggers Tools:DevToolbox is F12, and on OS X that switches displays to gadgets. <strong>Works on Windows, interestingly.</strong><br clear="none"/></div><div><strong><br clear="none"/></strong>devToolboxMenuItem is what I'm interested in. Interestingly, this doesn't have a keycode attribute. Just uses label, accesskey, keytext.<br clear="none"/></div><div><br clear="none"/></div><div>I think Cmd-Shift-K is specifically for bringing up the console. Check out _createToolMenuElements which seems to be injecting these handlers.<br clear="none"/></div><div><br clear="none"/></div><div>attachKeyBindingsToBrowser seems to be doing it's job properly - it's injecting the &lt;key> elements into the document. Also, it looks like the keyboard shortcuts work if the chrome is what's focused.<br clear="none"/></div><div><br clear="none"/></div><div>Q: How does key input work for remote browsers?<br clear="none"/></div><div><br clear="none"/></div><div>Things just get messaged down, and when they're done, I think the TabParent simulates the bubbling back up.<br clear="none"/></div><div><br clear="none"/></div><div>Q: Why do some &lt;key>'s work with content (like DOMi), and some do not? (DevTools console)<br clear="none"/></div><div><br clear="none"/></div><div>So it looks like in nsXBLWindowKeyHandler::WalkHandlersAndExecute, we get the handler, but then have !aExecute, so the handler is never fired! Ignoring aExecute, things work properly.<br clear="none"/></div><div><br clear="none"/></div><div>Q: Why is aExecute false?<br clear="none"/></div><div><br clear="none"/></div><div>It looks like after we get the reply from the content process, and the key event is redispatched, the XBL key handler doesn't seem to pick it up. The only reason aExecute was false was because this was during the capturing phase.<br clear="none"/></div><div><br clear="none"/></div><div>Q: Why isn't the event getting handled after the TabChild replies?<br clear="none"/></div><div><br clear="none"/></div><div>It looks like the handler is registered and waiting, but the information we're getting back to compare it against isn't exactly right.<br clear="none"/></div><div><br clear="none"/></div><div>I think this is because the charCode isn't being sent to the TabChild, and then isn't being echo'd back.<br clear="none"/></div><div><br clear="none"/></div><div>Q: Why isn't the charCode being sent to the child?<br clear="none"/></div><div><br clear="none"/></div><div>I'm not sure, and now I'm not so sure that it even matters. Is the charCode set when the keyboard event _works_, like with Browser Console?<br clear="none"/></div><div><br clear="none"/></div><div>Q: Is the charCode set when the keyboard event _works_, like with Browser Console?<br clear="none"/><div><br clear="none"/></div><div>INTERESTING. It looks like the events work if the modifiers are accel, shift - but NOT accel, alt.<br clear="none"/></div><div><br clear="none"/></div><div>Let me see if this is true for non-devtools things. It's true!<br clear="none"/></div><div><br clear="none"/></div><div>Alt seems to be the red-headed step-child here. Or, at least, in certain combinations.<br clear="none"/></div><div><br clear="none"/></div><div>Ctrl+Alt S works<br clear="none"/></div><div>Ctrl+Shift+Alt S works<br clear="none"/></div><div>Ctrl-Accel S works<br clear="none"/></div><div>Alt-Accel S _does not work_.<br clear="none"/></div><div><br clear="none"/></div><div>Q: Why is alt not getting any love from nsXBLWindowKeyHandler?<br clear="none"/></div><div><br clear="none"/></div><div>AH HAH. So, first of all, this bug only affects OS X.<br clear="none"/></div><div><br clear="none"/></div><div>Also, on OS X, Alt+[key] usually results in alternative (ha!) character. Example - Alt+j = âˆ†. That character is what's serialized and sent back over the wire. So no wonder we're not handling it.<br clear="none"/></div><div><br clear="none"/></div><div>Q: How do &lt;key>'s on OS X normally handle this?<br clear="none"/></div><div><br clear="none"/></div><div>nsContentUtils::GetAccelKeyCandidates seems to do the job here - basically, I think this takes some keyboard event, and returns candidate alternative key codes. This is failing with the events we get back from the child.<br clear="none"/></div><div><br clear="none"/></div><div>Q: Why is nsContentUtils::GetAccelKeyCandidates totally busted for the events that we get back from the child process?<br clear="none"/></div><div><br clear="none"/></div><div>I _think_ nsContentUtils::GetAccelKeyCandidates is not working because alternativeCharCodes on the WidgetKeyboardEvent isn't being properly serialized.</div><div><br clear="none"/></div><div>Hypothesis is correct! Got a patch up, but masayuki has suggestions.<br clear="none"/></div><div><br clear="none"/></div><div>evilpie wrote a variation on it, but still seems to think something is wrong.<br clear="none"/></div><div><br clear="none"/></div><div>Q: What is wrong with evilpie's patch?<br clear="none"/></div><div><br clear="none"/></div><div>"I first tried to get away with just serializing mozilla::AlternativeCharCode, but that doesn't work, because the serializer for for nsTArray needs an empty constructor."<br clear="none"/></div><div><br clear="none"/></div><div>Maybe it crashes? I'm going to try evilpie's patch to see if it actually works.<br clear="none"/></div><div><br clear="none"/></div><div>It works! It's just that evilpie couldn't test it - but it works really well.<br clear="none"/></div><div><br clear="none"/></div><div>evilpie is going to modify the patch to add a new type of serializer for AlternativeCharCodes which will clean things up again. Last round of review, and this puppy is DONE.<br clear="none"/></div></div></body></html>
